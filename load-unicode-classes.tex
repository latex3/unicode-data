% File load-unicode-classes.tex
%
% Copyright 2015 The LaTeX3 Project
%
% You may freely use, modify and/or distribute this file.
%
% Issues with this file should be reported at
% https://github.com/latex3/unicode-data
%
%
% =============================================================================
%
% The data loaded here can currently only be used by XeTeX: check for the
% appropriate primitive.
\ifx\XeTeXcharclass\undefined
  \expandafter\endinput
\fi
% This file can be loaded in IniTeX mode so the category codes of |{|, |}| and
% |#| may not be correct. Everything is done in a group so that only the
% settings we want to propagate are made available generally.
\begingroup
  \catcode`\{=1 %
  \catcode`\}=2 %
  \catcode`\#=12 %
% A string version of |#| will be needed to look for comment lines in the
% source. Once that is done proper parsing can begin.
  \def\hash{#}%
  \catcode`\#=6 %
  \def\firsttoken#1#2\relax{#1}%
  \def\parseunicodedataI#1\relax{%
    \unless\if\hash\firsttoken#1?\relax
      \parseunicodedataII#1\relax
    \fi
  }%
% Both files to be parsed here have potential ranges of code points: find the
% first entry and search for the second.
  \def\parseunicodedataII#1;#2 #3\relax{%
    \parseunicodedataIII#1....\relax{#2}%
  }%
% For the East Asian width data, save the class of the current token if
% it is |F|, |H| or |W|.
  \def\parseunicodedataIII#1..#2..#3\relax#4{%
    \expandafter\def\csname EAW@\number"#1\endcsname{#4}%
    \ifx\relax#2\relax
    \else
      \count0="#1 %
      \loop
        \ifnum\count0<"#2 %
          \advance\count0 by 1 %
          \expandafter\def\csname EAW@\number\count0\endcsname{#4}%
      \repeat
    \fi
  }%
% A shared routine for reading the data files: only one part of the parser
% has to be altered.
  \def\storedpar{\par}%
  \def\readandparse#1{%
    \openin0=#1.txt %
    \catcode`\#=12 %
    \loop\unless\ifeof0 %
      \read0 to \unicodedataline
      \unless\ifx\unicodedataline\storedpar
        \expandafter\parseunicodedataI\unicodedataline\relax
      \fi
    \repeat
    \catcode`\#=6 %
    \closein0 %
  }%
  \readandparse{EastAsianWidth}%
  \def\ID{ID}%
  \def\OP{2}%
  \def\CL{3}%
  \def\EX{3}%
  \def\IS{3}%
  \def\NS{3}%
  \def\CM{256}%
  \def\parseunicodedataIII#1..#2..#3\relax#4{%
    \def\temp{#4}%
    \ifx\temp\ID
      \ifx\relax#2\relax
        \parseunicodedataIV{#1}{#1}%
      \else
        \parseunicodedataIV{#1}{#2}%
      \fi
    \else
      \ifnum 0%
        \if F\csname EAW@\number"#1\endcsname 1\fi
        \if H\csname EAW@\number"#1\endcsname 1\fi
        \if W\csname EAW@\number"#1\endcsname 1\fi
         >0 %
       \global\XeTeXcharclass"#1=\csname#4\endcsname
      \fi
    \fi
  }%
  \def\parseunicodedataIV#1#2{%
    \begingroup
      \count0="#1 %
      \loop
        \ifnum\count0<"#2 %
          \global\XeTeXcharclass\count0=1 %
          \advance\count0 by 1 %
      \repeat
    \endgroup
  }%
  \readandparse{LineBreak}%
\endgroup
